# This file contains common pin mappings for the BigTreeTech Octopus
# (non-Pro) boards.

# Important! Do not use this config with an Octopus Pro v1.1 board as
# doing so could result in a heater being inadvertently enabled.

# To use this config, start by identifying the micro-controller on the
# board - it may be an STM32F446, or STM32F429.  Select the
# appropriate micro-controller in "make menuconfig" and select "Enable
# low-level configuration options". For STM32F446 boards the firmware
# should be compiled with a "32KiB bootloader" and a "12MHz crystal"
# clock reference. For STM32F429 boards use a "32KiB bootloader" and
# an "8MHz crystal".

# See docs/Config_Reference.md for a description of parameters.

#hostname="The Spartan"

[include mainsail.cfg]
[include Hotend.cfg]
#[include bedmesh.cfg]
#[include Backup.cfg]
[include Smart_Park.cfg]
[include Line_Purge.cfg]
[include KAMP_Settings.cfg]
[include 3 x Z Tilt.cfg]
[include Eddy.cfg]
[include Load-Unload.cfg]
[include SBLED.cfg]
[include Macros.cfg]
[include Timeout.cfg]
[include Knomi.cfg]
[include timelapse.cfg]

[exclude_object]

[input_shaper]

[force_move]
enable_force_move: True 

[mcu]
canbus_uuid: acb237dc69d3
canbus_interface: can0

[printer]
kinematics: corexy
max_velocity: 1000
max_accel: 3700
max_z_velocity: 5
max_z_accel: 100

[temperature_sensor Pad7]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor Octopus]
sensor_type: temperature_mcu
min_temp: 10
max_temp: 100

# Driver0
[stepper_x]
step_pin: PF13
dir_pin: PF12
enable_pin: !PF14
microsteps: 16
rotation_distance: 40
endstop_pin: !EBBCan:gpio24 #!PG6
position_endstop: -8
position_min: -8
position_max: 400
homing_speed: 100

[tmc5160 stepper_x]
#   https://www.klipper3d.org/TMC_Drivers.html
#   https://github.com/bigtreetech/BIGTREETECH-TMC5160-V1.0
cs_pin: PC4
spi_bus: spi1
sense_resistor: 0.075
run_current: 1.200
interpolate: false
stealthchop_threshold: 0

# Driver1
[stepper_y]
step_pin: PG0
dir_pin: PG1
enable_pin: !PF15
microsteps: 16
rotation_distance: 40
endstop_pin: !PG9
position_endstop: 0
position_min: 0
position_max: 400
homing_speed: 100

[tmc5160 stepper_y]
cs_pin: PD11
spi_bus: spi1
sense_resistor: 0.075
run_current: 1.200
interpolate: false
stealthchop_threshold: 0

# Driver2 z1
[stepper_z]
step_pin: PF11
dir_pin: !PG3
enable_pin: !PG5
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop #PG10
position_min: -2
position_max: 400
#position_endstop: 0.5

[tmc5160 stepper_z]
cs_pin: PC6
spi_bus: spi1
sense_resistor: 0.075
run_current: 1.000
interpolate: false
stealthchop_threshold: 0


# Driver3 z2
[stepper_z1]
step_pin: PG4
dir_pin: !PC1
enable_pin: !PA0
microsteps: 16
rotation_distance: 8

[tmc5160 stepper_z1]
cs_pin: PC7
spi_bus: spi1
sense_resistor: 0.075
run_current: 1.000
interpolate: false
stealthchop_threshold: 0

# Driver4 z3
[stepper_z2]
enable_pin: !PG2
step_pin: PF9
dir_pin: !PF10
microsteps: 16
rotation_distance: 8

[tmc5160 stepper_z2]
cs_pin: PF2
spi_bus: spi1
sense_resistor: 0.075
run_current: 1.000
interpolate: false
stealthchop_threshold: 0

# Driver5
#[stepper_z3]
#step_pin: PC13
#dir_pin: PF0 
#enable_pin: !PF1
#microsteps: 16
#rotation_distance: 8 

#[tmc5160 stepper_z3]
#cs_pin: PE4
#spi_bus: spi1
#sense_resistor: 0.075
#run_current: 0.800
#interpolate: false
#stealthchop_threshold: 999999

# Run Out #
[filament_switch_sensor switch_sensor]
switch_pin: ^PG12
pause_on_runout: true

runout_gcode:
 PAUSE # [pause_resume] is required in printer.cfg
 M117 Filament switch runout

insert_gcode:
 M117 Filament switch inserted

[filament_motion_sensor encoder_sensor]
switch_pin: ^PG13
detection_length: 2.88 # accuracy of motion sensor 2.88mm
extruder: extruder
pause_on_runout: true

runout_gcode:
 PAUSE # [pause_resume] is required in printer.cfg
 M117 Filament encoder runout

insert_gcode:
 M117 Filament encoder inserted

#[bltouch]
#sensor_pin: !PB7
#control_pin: PB6
#z_offset: 0

#[safe_z_home]
#home_xy_position: 250,250
#speed: 50
#z_hop: 10
#z_hop_speed: 50

#[bed_mesh]
#speed: 100
#horizontal_move_z: 5
#mesh_min: 35,35
#mesh_max: 450,485
##probe_count: 7,7
#move_check_distance: 3
#split_delta_z: .025
#mesh_pps: 2,3
#algorithm: bicubic
#bicubic_tension: 0.2


#[filament_switch_sensor material_0]
#switch_pin: PG12

#[filament_switch_sensor material_1]
#switch_pin: PG13

# Driver6
#[extruder]
#step_pin: PE2
#dir_pin: PE3
#enable_pin: !PD4
#microsteps: 16
#rotation_distance: 33.500
#nozzle_diameter: 0.400
#filament_diameter: 1.750
#heater_pin: PA2 # HE2
#sensor_pin: PF4 # T2
#sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
#min_temp: 0
#max_temp: 300
#max_extrude_only_distance: 800
#min_extrude_temp: 170
#max_extrude_cross_section: 1.5

#[tmc5160 extruder]
#cs_pin: PE1
#spi_bus: spi1
#sense_resistor: 0.075
#run_current: 1.2
#interpolate: false
#stealthchop_threshold: 1

#[filament_switch_sensor material_2]
#switch_pin: PG14

# Driver7
#[extruder3]
#step_pin: PE6
#dir_pin: PA14
#enable_pin: !PE0
#heater_pin: PB11 # HE3
#sensor_pin: PF7 # T3
#...

#[filament_switch_sensor material_3]
#switch_pin: PG15

[heater_bed]
heater_pin: PA1
sensor_pin: PF3 # TB
sensor_type: Generic 3950
#control: pid
#pid_Kp: 73.932
#pid_Ki: 1.521
#pid_Kd: 898.279
min_temp: 0
max_temp: 200

#####################################################################
#  Heater Verification
#####################################################################
[verify_heater heater_bed]
max_error: 120
check_gain_time: 120
hysteresis: 5
heating_gain: 1

[verify_heater extruder]
max_error: 120
check_gain_time: 20
hysteresis: 5
heating_gain: 2

#[fan]
#pin: PA8

[controller_fan MCU FAN]
pin: PE5


[controller_fan MCU2 FAN2]
pin: PD12


#[heater_fan Hot End]
#pin: PD13
#heater: extruder
#heater_temp: 80.0

#[fan]
#pin: PD14

#[controller_fan fan5]
#pin: PD15

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5
	
# FUCK

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3224082.723,0.090000:3223896.285,0.130000:3223334.255,
#*# 	0.170000:3222802.954,0.210000:3222250.981,0.250000:3221755.778,
#*# 	0.290000:3221225.320,0.330000:3220738.533,0.370000:3220190.544,
#*# 	0.410000:3219726.851,0.450000:3219246.243,0.490000:3218745.287,
#*# 	0.530000:3218273.146,0.570000:3217834.461,0.610000:3217373.625,
#*# 	0.650000:3216943.341,0.690000:3216475.136,0.730000:3216071.945,
#*# 	0.770000:3215638.645,0.810000:3215236.108,0.850000:3214816.771,
#*# 	0.890000:3214433.080,0.930000:3214021.490,0.970000:3213631.275,
#*# 	1.010000:3213245.362,1.050000:3212888.321,1.090000:3212489.390,
#*# 	1.130000:3212166.021,1.170000:3211805.146,1.210000:3211468.378,
#*# 	1.250000:3211095.312,1.290000:3210782.880,1.330000:3210463.959,
#*# 	1.370000:3210180.272,1.410000:3209860.364,1.450000:3209564.272,
#*# 	1.490000:3209214.360,1.530000:3208957.994,1.570000:3208625.674,
#*# 	1.610000:3208364.798,1.650000:3208093.895,1.690000:3207811.412,
#*# 	1.730000:3207529.759,1.770000:3207266.877,1.810000:3207012.670,
#*# 	1.850000:3206757.379,1.890000:3206462.204,1.930000:3206210.316,
#*# 	1.970000:3205968.390,2.010000:3205730.944,2.050000:3205464.933,
#*# 	2.090000:3205221.793,2.130000:3204989.107,2.170000:3204737.057,
#*# 	2.210000:3204538.189,2.250000:3204304.572,2.290000:3204080.409,
#*# 	2.330000:3203881.409,2.370000:3203643.303,2.410000:3203466.671,
#*# 	2.450000:3203259.276,2.490000:3203059.349,2.530000:3202884.191,
#*# 	2.570000:3202694.043,2.610000:3202492.504,2.650000:3202317.662,
#*# 	2.690000:3202136.216,2.730000:3201966.934,2.770000:3201809.045,
#*# 	2.810000:3201644.150,2.850000:3201455.553,2.890000:3201299.196,
#*# 	2.930000:3201127.302,2.970000:3200954.928,3.010000:3200794.535,
#*# 	3.050000:3200655.073,3.090000:3200493.094,3.130000:3200387.092,
#*# 	3.170000:3200204.705,3.210000:3200056.724,3.250000:3199869.109,
#*# 	3.290000:3199731.651,3.330000:3199587.647,3.370000:3199457.014,
#*# 	3.410000:3199317.652,3.450000:3199186.123,3.490000:3199041.134,
#*# 	3.530000:3198933.504,3.570000:3198813.787,3.610000:3198671.406,
#*# 	3.650000:3198547.066,3.690000:3198434.247,3.730000:3198302.341,
#*# 	3.770000:3198186.232,3.810000:3198072.711,3.850000:3197952.455,
#*# 	3.890000:3197827.690,3.930000:3197715.493,3.970000:3197595.676,
#*# 	4.010000:3197500.018,4.050000:3197382.831
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 40.926921
#*# drift_calibration =
#*# 	3251845.974395, -741.838159, 6.123526
#*# 	3242065.392382, -671.953031, 5.695293
#*# 	3231312.788742, -488.206064, 3.915937
#*# 	3221267.448884, -298.053409, 2.205694
#*# 	3213128.766154, -134.119555, 0.702984
#*# 	3209430.892777, -117.418444, 0.631972
#*# 	3203872.277308, 2.171522, -0.529154
#*# 	3200383.666460, 52.312482, -0.968204
#*# 	3198095.521550, 72.381559, -1.155851
#*# drift_calibration_min_temp = 38.23698463763412
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.078891, 0.067680, 0.061591, 0.080289, 0.068150, 0.098820, 0.111475, 0.086172, 0.107364, 0.100410, 0.077378, 0.119489, 0.075297, 0.085515, 0.063494, 0.054827, 0.063891, 0.092077, 0.082763, 0.109717, 0.094490
#*# 	  0.109150, 0.116470, 0.104461, 0.116885, 0.112902, 0.130417, 0.140018, 0.125422, 0.130046, 0.138092, 0.112615, 0.142073, 0.097034, 0.109326, 0.101302, 0.081907, 0.093261, 0.122909, 0.105753, 0.136181, 0.122107
#*# 	  0.138161, 0.144570, 0.137800, 0.143652, 0.143449, 0.160065, 0.179259, 0.150330, 0.158921, 0.166842, 0.123401, 0.169598, 0.125887, 0.137191, 0.116978, 0.104364, 0.113045, 0.145808, 0.117031, 0.143190, 0.135223
#*# 	  0.195291, 0.177370, 0.169134, 0.180377, 0.174899, 0.203731, 0.200172, 0.172363, 0.181231, 0.194466, 0.164433, 0.192313, 0.157679, 0.158586, 0.140851, 0.131434, 0.132116, 0.161783, 0.144263, 0.171306, 0.153960
#*# 	  0.211656, 0.191793, 0.197763, 0.194293, 0.204153, 0.208746, 0.227789, 0.197104, 0.212740, 0.221919, 0.183843, 0.213061, 0.171374, 0.162543, 0.135555, 0.132352, 0.140620, 0.162321, 0.136638, 0.176347, 0.138644
#*# 	  0.232242, 0.232510, 0.215092, 0.222173, 0.232113, 0.240857, 0.257690, 0.222310, 0.249673, 0.251483, 0.214252, 0.234345, 0.192246, 0.179904, 0.157353, 0.161611, 0.160019, 0.175590, 0.151082, 0.182802, 0.155329
#*# 	  0.256852, 0.254879, 0.247975, 0.246221, 0.246180, 0.260341, 0.273557, 0.256755, 0.258285, 0.265662, 0.216411, 0.243600, 0.191338, 0.194553, 0.158983, 0.155355, 0.148713, 0.175532, 0.155422, 0.183497, 0.155228
#*# 	  0.274393, 0.264650, 0.250431, 0.263721, 0.252187, 0.268031, 0.280708, 0.250315, 0.277301, 0.289639, 0.240181, 0.250532, 0.204243, 0.199675, 0.172235, 0.157208, 0.161506, 0.177399, 0.162029, 0.183687, 0.156865
#*# 	  0.317365, 0.286323, 0.284319, 0.282797, 0.283076, 0.287730, 0.289012, 0.269153, 0.298964, 0.293785, 0.257445, 0.277010, 0.224830, 0.216871, 0.174013, 0.170030, 0.157603, 0.184151, 0.161586, 0.185653, 0.165902
#*# 	  0.325253, 0.319690, 0.304088, 0.301278, 0.283124, 0.292757, 0.298656, 0.268149, 0.286696, 0.297897, 0.256920, 0.267464, 0.224518, 0.207196, 0.189032, 0.166707, 0.174360, 0.189398, 0.168159, 0.205246, 0.164489
#*# 	  0.342957, 0.332428, 0.304890, 0.291846, 0.278085, 0.276520, 0.284629, 0.271364, 0.275695, 0.275052, 0.238224, 0.253886, 0.200450, 0.190004, 0.163280, 0.152863, 0.151992, 0.173713, 0.149600, 0.175844, 0.158923
#*# 	  0.401006, 0.369114, 0.348974, 0.334383, 0.306132, 0.308667, 0.305900, 0.270166, 0.289539, 0.295440, 0.249528, 0.272166, 0.222892, 0.217173, 0.191269, 0.170170, 0.158566, 0.190952, 0.160318, 0.202487, 0.154392
#*# 	  0.402834, 0.390806, 0.354667, 0.337540, 0.311136, 0.296756, 0.290574, 0.249101, 0.256744, 0.254720, 0.210611, 0.238573, 0.181193, 0.188820, 0.153907, 0.132133, 0.126228, 0.154647, 0.128633, 0.170483, 0.122371
#*# 	  0.446025, 0.403883, 0.374737, 0.350139, 0.318029, 0.297386, 0.281280, 0.243713, 0.255563, 0.245777, 0.209429, 0.219675, 0.173872, 0.170744, 0.143432, 0.119494, 0.128503, 0.145353, 0.123092, 0.162091, 0.118216
#*# 	  0.464448, 0.423205, 0.386494, 0.357474, 0.329271, 0.295274, 0.283468, 0.237306, 0.236693, 0.222012, 0.177196, 0.188812, 0.146140, 0.139187, 0.121074, 0.099280, 0.105001, 0.130344, 0.104516, 0.134180, 0.084351
#*# 	  0.503310, 0.449854, 0.406961, 0.378301, 0.333446, 0.322821, 0.293926, 0.231181, 0.239788, 0.227815, 0.172350, 0.181197, 0.124260, 0.122839, 0.111512, 0.087577, 0.087579, 0.124401, 0.099591, 0.119768, 0.085609
#*# 	  0.509856, 0.451939, 0.415236, 0.378659, 0.344180, 0.311059, 0.293900, 0.237074, 0.218300, 0.191433, 0.135617, 0.156851, 0.090365, 0.102234, 0.072283, 0.058564, 0.061593, 0.098389, 0.068187, 0.103512, 0.030648
#*# 	  0.539655, 0.490930, 0.431437, 0.399060, 0.347811, 0.327219, 0.300697, 0.240086, 0.226973, 0.195795, 0.149010, 0.157272, 0.096752, 0.087138, 0.057960, 0.041474, 0.038378, 0.082338, 0.062711, 0.093297, 0.036323
#*# 	  0.552564, 0.491311, 0.440097, 0.397950, 0.351314, 0.314147, 0.296226, 0.236927, 0.213089, 0.185020, 0.123046, 0.135730, 0.066470, 0.054512, 0.010932, 0.002454, 0.000911, 0.039415, 0.002053, 0.043001, -0.026761
#*# 	  0.550242, 0.491726, 0.434715, 0.397755, 0.343700, 0.318466, 0.282692, 0.208537, 0.191814, 0.167240, 0.112048, 0.112734, 0.042553, 0.039921, 0.007870, -0.020692, -0.015373, 0.018989, -0.013935, 0.029409, -0.046659
#*# 	  0.574281, 0.525134, 0.462484, 0.423349, 0.364185, 0.337808, 0.298559, 0.243838, 0.212763, 0.178158, 0.111611, 0.115262, 0.033808, 0.049496, 0.002561, -0.027014, -0.018048, 0.000717, -0.031331, 0.009357, -0.068728
#*# x_count = 21
#*# y_count = 21
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 30.0
#*# max_x = 380.0
#*# min_y = 30.0
#*# max_y = 355.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 43.348
#*# pid_ki = 5.453
#*# pid_kd = 86.153
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 50.838
#*# pid_ki = 1.255
#*# pid_kd = 514.730
#*#
#*# [input_shaper]
#*# shaper_type_x = ei
#*# shaper_freq_x = 52.2
#*# shaper_type_y = 2hump_ei
#*# shaper_freq_y = 41.4
